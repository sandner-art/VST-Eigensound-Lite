<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MolecularSynth</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            touch-action: manipulation;
            user-select: none;
        }

        .app {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #000;
        }

        .header {
            height: 40px;
            background: linear-gradient(135deg, #111 0%, #1a1a1a 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            flex-shrink: 0;
            border-bottom: 1px solid #333;
        }

        .logo {
            font-size: 14px;
            font-weight: 600;
            color: #00d4aa;
            letter-spacing: 1px;
        }

        .modes {
            display: flex;
            gap: 8px;
        }

        .mode {
            padding: 4px 8px;
            background: transparent;
            color: #666;
            border: 1px solid #333;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            text-transform: uppercase;
            transition: all 0.2s;
        }

        .mode.active {
            background: #00d4aa;
            color: #000;
            border-color: #00d4aa;
        }

        .main {
            flex: 1;
            display: flex;
            min-height: 0;
        }

        .workspace {
            flex: 1;
            background: radial-gradient(circle at center, #0a0a0a 0%, #000 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            position: relative;
        }

        .molecule-area {
            width: 100%;
            height: 100%;
            max-width: 500px;
            max-height: 400px;
            background: radial-gradient(ellipse at center, rgba(0,212,170,0.05) 0%, transparent 70%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 1px solid rgba(0,212,170,0.1);
        }

        .molecule-svg {
            width: 90%;
            height: 90%;
            max-width: 400px;
            max-height: 300px;
        }

        .atom {
            cursor: pointer;
            transition: all 0.15s ease;
            filter: drop-shadow(0 0 3px rgba(0,212,170,0.4));
        }

        .atom:hover {
            transform: scale(1.3);
            filter: drop-shadow(0 0 8px rgba(0,212,170,0.8));
        }

        .atom.playing {
            animation: pulse 0.8s ease-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            30% { transform: scale(1.5); filter: drop-shadow(0 0 15px rgba(0,212,170,1)); }
            100% { transform: scale(1); }
        }

        .bond {
            stroke: #444;
            stroke-width: 1.5;
            transition: all 0.15s ease;
        }

        .bond:hover {
            stroke: #00d4aa;
            stroke-width: 2.5;
        }

        .info {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0,0,0,0.8);
            padding: 8px;
            border-radius: 4px;
            font-size: 10px;
            line-height: 1.3;
            border: 1px solid rgba(0,212,170,0.2);
        }

        .controls {
            width: 240px;
            background: linear-gradient(135deg, #111 0%, #0f0f0f 100%);
            padding: 10px;
            overflow-y: auto;
            flex-shrink: 0;
            border-left: 1px solid #333;
        }

        .section {
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 9px;
            color: #00d4aa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            padding-bottom: 3px;
            border-bottom: 1px solid rgba(0,212,170,0.2);
        }

        .control {
            margin-bottom: 10px;
        }

        .control-label {
            font-size: 9px;
            color: #999;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }

        .slider {
            width: 100%;
            height: 4px;
            background: #333;
            border-radius: 2px;
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #00d4aa;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0,212,170,0.3);
        }

        .slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: #00d4aa;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 8px rgba(0,212,170,0.3);
        }

        .presets {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }

        .preset {
            padding: 6px;
            background: #222;
            color: #999;
            cursor: pointer;
            font-size: 8px;
            text-align: center;
            border-radius: 3px;
            transition: all 0.15s;
            text-transform: uppercase;
            border: 1px solid #333;
        }

        .preset:hover {
            background: rgba(0,212,170,0.1);
            border-color: #00d4aa;
            color: #00d4aa;
        }

        .preset.active {
            background: #00d4aa;
            color: #000;
            border-color: #00d4aa;
        }

        .bottom {
            height: 60px;
            background: linear-gradient(135deg, #111 0%, #1a1a1a 100%);
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 10px;
            flex-shrink: 0;
            border-top: 1px solid #333;
        }

        .transport {
            display: flex;
            gap: 8px;
        }

        .btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #222;
            color: #999;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.15s;
            border: 1px solid #333;
        }

        .btn:hover {
            background: rgba(0,212,170,0.1);
            border-color: #00d4aa;
            color: #00d4aa;
        }

        .btn.active {
            background: #00d4aa;
            color: #000;
            border-color: #00d4aa;
        }

        .visualizer {
            flex: 1;
            height: 24px;
            background: #222;
            border-radius: 3px;
            display: flex;
            align-items: end;
            padding: 2px;
            gap: 1px;
            margin: 0 10px;
            border: 1px solid #333;
        }

        .bar {
            flex: 1;
            background: linear-gradient(to top, #00d4aa 0%, rgba(0,212,170,0.6) 100%);
            border-radius: 1px;
            min-height: 1px;
            transition: height 0.1s ease;
        }

        .volume {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            color: #666;
        }

        .volume-slider {
            width: 60px;
            height: 3px;
            background: #333;
            border-radius: 2px;
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 10px;
            height: 10px;
            background: #00d4aa;
            border-radius: 50%;
            cursor: pointer;
        }

        .volume-slider::-moz-range-thumb {
            width: 10px;
            height: 10px;
            background: #00d4aa;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        /* Mobile Landscape */
        @media (max-height: 600px) and (orientation: landscape) {
            .main {
                flex-direction: row;
            }
            
            .controls {
                width: 200px;
                border-left: 1px solid #222;
            }
            
            .header {
                height: 35px;
            }
            
            .bottom {
                height: 50px;
            }
        }

        /* Mobile Portrait */
        @media (max-width: 768px) and (orientation: portrait) {
            .main {
                flex-direction: column;
            }
            
            .controls {
                width: 100%;
                height: 180px;
                border-top: 1px solid #222;
                border-left: none;
            }
            
            .section {
                margin-bottom: 10px;
            }
            
            .presets {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Very small screens */
        @media (max-width: 480px) {
            .modes {
                gap: 4px;
            }
            
            .mode {
                padding: 3px 6px;
                font-size: 9px;
            }
            
            .logo {
                font-size: 12px;
            }
        }

        .quantum-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 9px;
            color: #666;
            background: rgba(0,0,0,0.7);
            padding: 4px 6px;
            border-radius: 3px;
            border: 1px solid rgba(0,212,170,0.2);
        }

        .mode-indicator {
            position: absolute;
            bottom: 8px;
            right: 8px;
            font-size: 8px;
            color: #00d4aa;
            background: rgba(0,212,170,0.1);
            padding: 3px 6px;
            border-radius: 3px;
            text-transform: uppercase;
            border: 1px solid rgba(0,212,170,0.3);
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <div class="logo">MolecularSynth</div>
            <div class="modes">
                <button class="mode active" data-mode="structural">Structural</button>
                <button class="mode" data-mode="electronic">Electronic</button>
                <button class="mode" data-mode="dynamic">Dynamic</button>
                <button class="mode" data-mode="spectral">Spectral</button>
            </div>
        </div>

        <div class="main">
            <div class="workspace">
                <div class="molecule-area">
                    <svg class="molecule-svg" viewBox="0 0 300 200" id="moleculeDisplay">
                        <!-- Molecule structure will be dynamically generated -->
                    </svg>

                    <div class="info">
                        <div id="mol-name">Caffeine (C‚ÇàH‚ÇÅ‚ÇÄN‚ÇÑO‚ÇÇ)</div>
                        <div id="mol-props">MW: 194.19 g/mol</div>
                        <div id="mol-key">HOMO-LUMO: 4.2 eV</div>
                    </div>

                    <div class="quantum-indicator" id="quantumProps">
                        <div>Dipole: 3.64 D</div>
                        <div>œá: 2.0-2.5</div>
                    </div>

                    <div class="mode-indicator" id="currentMode">
                        Structural Learning
                    </div>
                </div>
            </div>

            <div class="controls">
                <div class="section">
                    <div class="section-title">Sonification Model</div>
                    
                    <div class="control">
                        <div class="control-label">
                            <span>Parameter Mapping</span>
                            <span id="mapping-val">quantum</span>
                        </div>
                        <input type="range" class="slider" min="0" max="3" value="2" id="mapping" step="1">
                    </div>
                    
                    <div class="control">
                        <div class="control-label">
                            <span>Harmonic Complexity</span>
                            <span id="harmony-val">65%</span>
                        </div>
                        <input type="range" class="slider" min="0" max="100" value="65" id="harmony">
                    </div>
                    
                    <div class="control">
                        <div class="control-label">
                            <span>Electronic Resonance</span>
                            <span id="resonance-val">40%</span>
                        </div>
                        <input type="range" class="slider" min="0" max="100" value="40" id="resonance">
                    </div>
                    
                    <div class="control">
                        <div class="control-label">
                            <span>Molecular Dynamics</span>
                            <span id="dynamics-val">75%</span>
                        </div>
                        <input type="range" class="slider" min="0" max="100" value="75" id="dynamics">
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">Performance</div>
                    
                    <div class="control">
                        <div class="control-label">
                            <span>Tempo (BPM)</span>
                            <span id="tempo-val">120</span>
                        </div>
                        <input type="range" class="slider" min="60" max="200" value="120" id="tempo">
                    </div>
                    
                    <div class="control">
                        <div class="control-label">
                            <span>Expression Depth</span>
                            <span id="expression-val">50%</span>
                        </div>
                        <input type="range" class="slider" min="0" max="100" value="50" id="expression">
                    </div>

                    <div class="control">
                        <div class="control-label">
                            <span>Spatial Width</span>
                            <span id="spatial-val">30%</span>
                        </div>
                        <input type="range" class="slider" min="0" max="100" value="30" id="spatial">
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">Molecules</div>
                    <div class="presets">
                        <div class="preset active" data-mol="caffeine">Caffeine</div>
                        <div class="preset" data-mol="dopamine">Dopamine</div>
                        <div class="preset" data-mol="water">Water</div>
                        <div class="preset" data-mol="ethanol">Ethanol</div>
                        <div class="preset" data-mol="glucose">Glucose</div>
                        <div class="preset" data-mol="benzene">Benzene</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom">
            <div class="transport">
                <button class="btn" id="play-btn">‚ñ∂</button>
                <button class="btn" id="stop-btn">‚èπ</button>
                <button class="btn" id="rec-btn">‚è∫</button>
                <button class="btn" id="loop-btn">üîÑ</button>
            </div>
            
            <div class="visualizer">
                <div class="bar" style="height: 30%"></div>
                <div class="bar" style="height: 60%"></div>
                <div class="bar" style="height: 40%"></div>
                <div class="bar" style="height: 80%"></div>
                <div class="bar" style="height: 20%"></div>
                <div class="bar" style="height: 70%"></div>
                <div class="bar" style="height: 50%"></div>
                <div class="bar" style="height: 90%"></div>
                <div class="bar" style="height: 35%"></div>
                <div class="bar" style="height: 65%"></div>
                <div class="bar" style="height: 25%"></div>
                <div class="bar" style="height: 85%"></div>
            </div>

            <div class="volume">
                <span>üîä</span>
                <input type="range" class="volume-slider" min="0" max="100" value="70" id="master-vol">
            </div>
        </div>
    </div>

    <script>
        // Enhanced Audio Engine with Scientific Parameter Mapping
        let audioCtx;
        let masterGain;
        let isPlaying = false;
        let isLooping = false;
        let tempo = 120;
        let sequenceTimeout;
        let currentMolecule = 'caffeine';
        let currentMode = 'structural';

        // Scientific sonification parameters
        const mappingModes = ['direct', 'scaled', 'quantum', 'harmonic'];
        let currentMapping = 2; // quantum

        // Enhanced element data with quantum mechanical properties
        const elementData = {
            'C': { 
                wave: 'sawtooth', 
                color: '#666', 
                electronegativity: 2.55,
                atomicRadius: 70,
                baseFreq: 261.63,
                harmonics: [1, 2, 3, 5, 8] // Fibonacci harmonics for carbon
            },
            'N': { 
                wave: 'square', 
                color: '#4a90e2', 
                electronegativity: 3.04,
                atomicRadius: 65,
                baseFreq: 329.63,
                harmonics: [1, 3, 5, 7, 9] // Odd harmonics for nitrogen
            },
            'O': { 
                wave: 'triangle', 
                color: '#e74c3c', 
                electronegativity: 3.44,
                atomicRadius: 60,
                baseFreq: 415.30,
                harmonics: [1, 2, 4, 6, 8] // Even harmonics for oxygen
            },
            'H': { 
                wave: 'sine', 
                color: '#fff', 
                electronegativity: 2.20,
                atomicRadius: 25,
                baseFreq: 523.25,
                harmonics: [1] // Pure tone for hydrogen
            }
        };

        // Comprehensive molecule database with quantum properties
        const moleculeDB = {
            caffeine: {
                name: 'Caffeine (C‚ÇàH‚ÇÅ‚ÇÄN‚ÇÑO‚ÇÇ)',
                formula: 'C8H10N4O2',
                mw: 194.19,
                homoLumo: 4.2,
                dipole: 3.64,
                electronegativity: 2.3,
                key: 'A Minor',
                tempo: 120,
                structure: {
                    atoms: [
                        {x: 80, y: 100, element: 'C', freq: 261.63},
                        {x: 120, y: 80, element: 'N', freq: 329.63},
                        {x: 160, y: 100, element: 'C', freq: 392.00},
                        {x: 160, y: 140, element: 'N', freq: 466.16},
                        {x: 120, y: 160, element: 'C', freq: 523.25},
                        {x: 80, y: 140, element: 'C', freq: 587.33},
                        {x: 200, y: 80, element: 'C', freq: 659.25},
                        {x: 240, y: 100, element: 'O', freq: 698.46},
                        {x: 240, y: 140, element: 'N', freq: 783.99},
                        {x: 200, y: 160, element: 'C', freq: 880.00},
                        {x: 60, y: 90, element: 'H', freq: 1046.50, size: 4},
                        {x: 60, y: 150, element: 'H', freq: 1174.66, size: 4},
                        {x: 260, y: 120, element: 'H', freq: 1318.51, size: 4}
                    ],
                    bonds: [
                        {x1: 80, y1: 100, x2: 120, y2: 80},
                        {x1: 120, y1: 80, x2: 160, y2: 100},
                        {x1: 160, y1: 100, x2: 160, y2: 140},
                        {x1: 160, y1: 140, x2: 120, y2: 160},
                        {x1: 120, y1: 160, x2: 80, y2: 140},
                        {x1: 80, y1: 140, x2: 80, y2: 100},
                        {x1: 160, y1: 100, x2: 200, y2: 80},
                        {x1: 200, y1: 80, x2: 240, y2: 100},
                        {x1: 240, y1: 100, x2: 240, y2: 140},
                        {x1: 240, y1: 140, x2: 200, y2: 160},
                        {x1: 200, y1: 160, x2: 160, y2: 140}
                    ]
                }
            },
            water: {
                name: 'Water (H‚ÇÇO)',
                formula: 'H2O',
                mw: 18.02,
                homoLumo: 12.6,
                dipole: 1.85,
                electronegativity: 3.1,
                key: 'F Major',
                tempo: 90,
                structure: {
                    atoms: [
                        {x: 150, y: 100, element: 'O', freq: 415.30},
                        {x: 120, y: 80, element: 'H', freq: 523.25, size: 6},
                        {x: 180, y: 80, element: 'H', freq: 659.25, size: 6}
                    ],
                    bonds: [
                        {x1: 150, y1: 100, x2: 120, y2: 80},
                        {x1: 150, y1: 100, x2: 180, y2: 80}
                    ]
                }
            },
            dopamine: {
                name: 'Dopamine (C‚ÇàH‚ÇÅ‚ÇÅNO‚ÇÇ)',
                formula: 'C8H11NO2',
                mw: 153.18,
                homoLumo: 3.8,
                dipole: 2.1,
                electronegativity: 2.4,
                key: 'C Major',
                tempo: 140,
                structure: {
                    atoms: [
                        {x: 60, y: 120, element: 'C', freq: 261.63},
                        {x: 100, y: 100, element: 'C', freq: 293.66},
                        {x: 140, y: 120, element: 'C', freq: 329.63},
                        {x: 140, y: 160, element: 'C', freq: 369.99},
                        {x: 100, y: 180, element: 'C', freq: 415.30},
                        {x: 60, y: 160, element: 'C', freq: 466.16},
                        {x: 180, y: 140, element: 'O', freq: 523.25},
                        {x: 180, y: 180, element: 'O', freq: 587.33},
                        {x: 220, y: 120, element: 'C', freq: 659.25},
                        {x: 260, y: 140, element: 'C', freq: 698.46},
                        {x: 280, y: 180, element: 'N', freq: 783.99}
                    ],
                    bonds: [
                        {x1: 60, y1: 120, x2: 100, y2: 100},
                        {x1: 100, y1: 100, x2: 140, y2: 120},
                        {x1: 140, y1: 120, x2: 140, y2: 160},
                        {x1: 140, y1: 160, x2: 100, y2: 180},
                        {x1: 100, y1: 180, x2: 60, y2: 160},
                        {x1: 60, y1: 160, x2: 60, y2: 120},
                        {x1: 140, y1: 120, x2: 180, y2: 140},
                        {x1: 140, y1: 160, x2: 180, y2: 180},
                        {x1: 180, y1: 140, x2: 220, y2: 120},
                        {x1: 220, y1: 120, x2: 260, y2: 140},
                        {x1: 260, y1: 140, x2: 280, y2: 180}
                    ]
                }
            },
            ethanol: {
                name: 'Ethanol (C‚ÇÇH‚ÇÜO)',
                formula: 'C2H6O',
                mw: 46.07,
                homoLumo: 8.9,
                dipole: 1.69,
                electronegativity: 2.3,
                key: 'G Minor',
                tempo: 110,
                structure: {
                    atoms: [
                        {x: 120, y: 100, element: 'C', freq: 261.63},
                        {x: 180, y: 100, element: 'C', freq: 329.63},
                        {x: 220, y: 80, element: 'O', freq: 415.30},
                        {x: 100, y: 80, element: 'H', freq: 523.25, size: 4},
                        {x: 100, y: 120, element: 'H', freq: 587.33, size: 4},
                        {x: 140, y: 130, element: 'H', freq: 659.25, size: 4},
                        {x: 200, y: 130, element: 'H', freq: 698.46, size: 4},
                        {x: 160, y: 80, element: 'H', freq: 783.99, size: 4},
                        {x: 240, y: 60, element: 'H', freq: 880.00, size: 4}
                    ],
                    bonds: [
                        {x1: 120, y1: 100, x2: 180, y2: 100},
                        {x1: 180, y1: 100, x2: 220, y2: 80}
                    ]
                }
            },
            glucose: {
                name: 'Glucose (C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ)',
                formula: 'C6H12O6',
                mw: 180.16,
                homoLumo: 5.1,
                dipole: 2.8,
                electronegativity: 2.5,
                key: 'D Major',
                tempo: 100,
                structure: {
                    atoms: [
                        {x: 60, y: 120, element: 'C', freq: 261.63},
                        {x: 120, y: 100, element: 'C', freq: 293.66},
                        {x: 180, y: 120, element: 'C', freq: 329.63},
                        {x: 220, y: 160, element: 'C', freq: 369.99},
                        {x: 180, y: 200, element: 'C', freq: 415.30},
                        {x: 120, y: 180, element: 'C', freq: 466.16},
                        {x: 60, y: 80, element: 'O', freq: 523.25},
                        {x: 120, y: 60, element: 'O', freq: 587.33},
                        {x: 220, y: 100, element: 'O', freq: 659.25},
                        {x: 260, y: 180, element: 'O', freq: 698.46},
                        {x: 220, y: 220, element: 'O', freq: 783.99},
                        {x: 80, y: 200, element: 'O', freq: 880.00}
                    ],
                    bonds: [
                        {x1: 60, y1: 120, x2: 120, y2: 100},
                        {x1: 120, y1: 100, x2: 180, y2: 120},
                        {x1: 180, y1: 120, x2: 220, y2: 160},
                        {x1: 220, y1: 160, x2: 180, y2: 200},
                        {x1: 180, y1: 200, x2: 120, y2: 180},
                        {x1: 120, y1: 180, x2: 60, y2: 120}
                    ]
                }
            },
            benzene: {
                name: 'Benzene (C‚ÇÜH‚ÇÜ)',
                formula: 'C6H6',
                mw: 78.11,
                homoLumo: 6.8,
                dipole: 0.0,
                electronegativity: 2.5,
                key: 'E Minor',
                tempo: 132,
                structure: {
                    atoms: [
                        {x: 150, y: 80, element: 'C', freq: 261.63},
                        {x: 190, y: 110, element: 'C', freq: 293.66},
                        {x: 190, y: 150, element: 'C', freq: 329.63},
                        {x: 150, y: 180, element: 'C', freq: 369.99},
                        {x: 110, y: 150, element: 'C', freq: 415.30},
                        {x: 110, y: 110, element: 'C', freq: 466.16},
                        {x: 150, y: 60, element: 'H', freq: 523.25, size: 4},
                        {x: 210, y: 90, element: 'H', freq: 587.33, size: 4},
                        {x: 210, y: 170, element: 'H', freq: 659.25, size: 4},
                        {x: 150, y: 200, element: 'H', freq: 698.46, size: 4},
                        {x: 90, y: 170, element: 'H', freq: 783.99, size: 4},
                        {x: 90, y: 90, element: 'H', freq: 880.00, size: 4}
                    ],
                    bonds: [
                        {x1: 150, y1: 80, x2: 190, y2: 110},
                        {x1: 190, y1: 110, x2: 190, y2: 150},
                        {x1: 190, y1: 150, x2: 150, y2: 180},
                        {x1: 150, y1: 180, x2: 110, y2: 150},
                        {x1: 110, y1: 150, x2: 110, y2: 110},
                        {x1: 110, y1: 110, x2: 150, y2: 80}
                    ]
                }
            }
        };

        // Audio synthesis with scientific parameter mapping
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                masterGain = audioCtx.createGain();
                masterGain.connect(audioCtx.destination);
                masterGain.gain.value = 0.7;
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // Enhanced atom sonification with scientific accuracy
        function playAtom(element, frequency, atomIndex = 0) {
            initAudio();

            const molData = moleculeDB[currentMolecule];
            const elemData = elementData[element];
            const harmonyLevel = document.getElementById('harmony').value / 100;
            const resonanceLevel = document.getElementById('resonance').value / 100;
            const dynamicsLevel = document.getElementById('dynamics').value / 100;
            const spatialWidth = document.getElementById('spatial').value / 100;

            // Create audio graph
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const filter = audioCtx.createBiquadFilter();
            const panner = audioCtx.createStereoPanner();

            // Quantum mechanical frequency adjustment
            let adjustedFreq = frequency;
            switch(currentMapping) {
                case 0: // direct
                    adjustedFreq = frequency;
                    break;
                case 1: // scaled
                    adjustedFreq = frequency * (molData.mw / 100);
                    break;
                case 2: // quantum
                    adjustedFreq = frequency * (molData.homoLumo / 5) * (elemData.electronegativity / 3);
                    break;
                case 3: // harmonic
                    adjustedFreq = frequency * Math.pow(2, Math.floor(molData.homoLumo) % 12 / 12);
                    break;
            }

            // Mode-specific synthesis
            switch(currentMode) {
                case 'structural':
                    osc.type = elemData.wave;
                    break;
                case 'electronic':
                    osc.type = 'square';
                    // Add harmonic complexity based on element
                    if (harmonyLevel > 0.5) {
                        const harmonics = elemData.harmonics || [1];
                        harmonics.forEach((harmonic, i) => {
                            if (i > 0) {
                                const harmonicOsc = audioCtx.createOscillator();
                                const harmonicGain = audioCtx.createGain();
                                harmonicOsc.frequency.setValueAtTime(adjustedFreq * harmonic, audioCtx.currentTime);
                                harmonicOsc.type = 'sine';
                                harmonicGain.gain.setValueAtTime(0.1 * harmonyLevel / harmonic, audioCtx.currentTime);
                                harmonicOsc.connect(harmonicGain);
                                harmonicGain.connect(filter);
                                harmonicOsc.start(audioCtx.currentTime);
                                harmonicOsc.stop(audioCtx.currentTime + 0.8);
                            }
                        });
                    }
                    break;
                case 'dynamic':
                    osc.type = 'sawtooth';
                    // Add vibrato based on molecular dynamics
                    const vibrato = audioCtx.createOscillator();
                    const vibratoGain = audioCtx.createGain();
                    vibrato.frequency.setValueAtTime(5 * dynamicsLevel, audioCtx.currentTime);
                    vibratoGain.gain.setValueAtTime(adjustedFreq * 0.05 * dynamicsLevel, audioCtx.currentTime);
                    vibrato.connect(vibratoGain);
                    vibratoGain.connect(osc.frequency);
                    vibrato.start(audioCtx.currentTime);
                    vibrato.stop(audioCtx.currentTime + 0.8);
                    break;
                case 'spectral':
                    osc.type = 'triangle';
                    // Spectroscopic simulation with filter sweeps
                    filter.frequency.setValueAtTime(adjustedFreq * 0.5, audioCtx.currentTime);
                    filter.frequency.exponentialRampToValueAtTime(adjustedFreq * 4, audioCtx.currentTime + 0.4);
                    filter.frequency.exponentialRampToValueAtTime(adjustedFreq * 0.5, audioCtx.currentTime + 0.8);
                    break;
            }

            osc.frequency.setValueAtTime(adjustedFreq, audioCtx.currentTime);

            // Filter configuration based on electronegativity
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(adjustedFreq * (2 + resonanceLevel * 3), audioCtx.currentTime);
            filter.Q.setValueAtTime(elemData.electronegativity * resonanceLevel * 10, audioCtx.currentTime);

            // Spatial positioning based on atom position and molecular dipole
            const atomPos = molData.structure.atoms[atomIndex] || {x: 150, y: 100};
            const normalizedX = (atomPos.x - 150) / 150; // Normalize to -1 to 1
            panner.pan.setValueAtTime(normalizedX * spatialWidth, audioCtx.currentTime);

            // ADSR envelope with element-specific characteristics
            const attackTime = element === 'H' ? 0.01 : 0.05;
            const decayTime = elemData.atomicRadius / 100;
            const sustainLevel = 0.1 + (elemData.electronegativity / 4) * 0.3;
            const releaseTime = 0.8 - decayTime;

            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.4, audioCtx.currentTime + attackTime);
            gain.gain.exponentialRampToValueAtTime(sustainLevel, audioCtx.currentTime + attackTime + decayTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + releaseTime);

            // Connect audio graph
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(panner);
            panner.connect(masterGain);

            // Start and stop
            osc.start(audioCtx.currentTime);
            osc.stop(audioCtx.currentTime + releaseTime);

            updateVisualizer();
        }

        // Render molecule structure
        function renderMolecule(molKey) {
            const mol = moleculeDB[molKey];
            const svg = document.getElementById('moleculeDisplay');
            svg.innerHTML = '';

            // Draw bonds first (behind atoms)
            mol.structure.bonds.forEach(bond => {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', bond.x1);
                line.setAttribute('y1', bond.y1);
                line.setAttribute('x2', bond.x2);
                line.setAttribute('y2', bond.y2);
                line.setAttribute('class', 'bond');
                svg.appendChild(line);
            });

            // Draw atoms
            mol.structure.atoms.forEach((atom, index) => {
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', atom.x);
                circle.setAttribute('cy', atom.y);
                circle.setAttribute('r', atom.size || 8);
                circle.setAttribute('fill', elementData[atom.element].color);
                circle.setAttribute('class', 'atom');
                circle.setAttribute('data-element', atom.element);
                circle.setAttribute('data-freq', atom.freq);
                circle.setAttribute('data-index', index);
                
                circle.addEventListener('click', function() {
                    const element = this.getAttribute('data-element');
                    const frequency = parseFloat(this.getAttribute('data-freq'));
                    const atomIndex = parseInt(this.getAttribute('data-index'));
                    
                    this.classList.add('playing');
                    setTimeout(() => this.classList.remove('playing'), 800);
                    
                    playAtom(element, frequency, atomIndex);
                });
                
                svg.appendChild(circle);
            });
        }

        // Update molecule information display
        function updateMoleculeInfo(molKey) {
            const mol = moleculeDB[molKey];
            document.getElementById('mol-name').textContent = mol.name;
            document.getElementById('mol-props').textContent = `MW: ${mol.mw} g/mol`;
            document.getElementById('mol-key').textContent = `HOMO-LUMO: ${mol.homoLumo} eV`;
            
            const quantumProps = document.getElementById('quantumProps');
            quantumProps.innerHTML = `
                <div>Dipole: ${mol.dipole} D</div>
                <div>œá: ${mol.electronegativity}</div>
            `;

            document.getElementById('tempo').value = mol.tempo;
            updateSliderValue(document.getElementById('tempo'), document.getElementById('tempo-val'));
        }

        // Play molecular sequence with scientific timing
        function playSequence() {
            if (!isPlaying) return;

            const mol = moleculeDB[currentMolecule];
            const atoms = mol.structure.atoms;
            const currentTempo = parseInt(document.getElementById('tempo').value);
            const interval = 60000 / (currentTempo * 2); // 8th notes

            atoms.forEach((atom, i) => {
                setTimeout(() => {
                    if (isPlaying) {
                        const atomElements = document.querySelectorAll(`[data-index="${i}"]`);
                        if (atomElements.length > 0) {
                            const atomEl = atomElements[0];
                            atomEl.classList.add('playing');
                            setTimeout(() => atomEl.classList.remove('playing'), 800);
                            
                            playAtom(atom.element, atom.freq, i);
                        }
                    }
                }, i * interval);
            });

            if (isLooping) {
                sequenceTimeout = setTimeout(playSequence, atoms.length * interval + 1000);
            }
        }

        // Update visualizer with enhanced graphics
        function updateVisualizer() {
            const bars = document.querySelectorAll('.bar');
            bars.forEach((bar, i) => {
                const height = Math.random() * 80 + 10;
                bar.style.height = height + '%';
                bar.style.background = `linear-gradient(to top, #00d4aa ${Math.random() * 50}%, rgba(0,212,170,0.6) 100%)`;
            });
        }

        // Update slider values with scientific parameter mapping
        function updateSliderValue(slider, valueSpan, suffix = '%') {
            const value = slider.value;
            if (slider.id === 'tempo') {
                valueSpan.textContent = value;
                tempo = parseInt(value);
            } else if (slider.id === 'mapping') {
                const modes = ['direct', 'scaled', 'quantum', 'harmonic'];
                valueSpan.textContent = modes[parseInt(value)];
                currentMapping = parseInt(value);
            } else {
                valueSpan.textContent = value + suffix;
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize with caffeine
            renderMolecule('caffeine');
            updateMoleculeInfo('caffeine');

            // Transport controls
            document.getElementById('play-btn').addEventListener('click', function() {
                initAudio();
                isPlaying = !isPlaying;
                
                if (isPlaying) {
                    this.textContent = '‚è∏';
                    this.classList.add('active');
                    playSequence();
                } else {
                    this.textContent = '‚ñ∂';
                    this.classList.remove('active');
                    clearTimeout(sequenceTimeout);
                }
            });

            document.getElementById('stop-btn').addEventListener('click', function() {
                isPlaying = false;
                isLooping = false;
                clearTimeout(sequenceTimeout);
                const playBtn = document.getElementById('play-btn');
                playBtn.textContent = '‚ñ∂';
                playBtn.classList.remove('active');
                document.getElementById('loop-btn').classList.remove('active');
            });

            document.getElementById('loop-btn').addEventListener('click', function() {
                isLooping = !isLooping;
                this.classList.toggle('active');
            });

            document.getElementById('rec-btn').addEventListener('click', function() {
                this.classList.toggle('active');
                console.log('Recording:', this.classList.contains('active'));
            });

            // Mode switches
            document.querySelectorAll('.mode').forEach(mode => {
                mode.addEventListener('click', function() {
                    document.querySelectorAll('.mode').forEach(m => m.classList.remove('active'));
                    this.classList.add('active');
                    currentMode = this.dataset.mode;
                    
                    const modeNames = {
                        'structural': 'Structural Learning',
                        'electronic': 'Electronic Properties', 
                        'dynamic': 'Molecular Dynamics',
                        'spectral': 'Spectroscopic Analysis'
                    };
                    document.getElementById('currentMode').textContent = modeNames[currentMode];
                });
            });

            // Molecule presets
            document.querySelectorAll('.preset').forEach(preset => {
                preset.addEventListener('click', function() {
                    document.querySelectorAll('.preset').forEach(p => p.classList.remove('active'));
                    this.classList.add('active');
                    currentMolecule = this.dataset.mol;
                    renderMolecule(currentMolecule);
                    updateMoleculeInfo(currentMolecule);
                });
            });

            // Sliders
            const sliders = [
                { slider: 'mapping', value: 'mapping-val' },
                { slider: 'harmony', value: 'harmony-val' },
                { slider: 'resonance', value: 'resonance-val' },
                { slider: 'dynamics', value: 'dynamics-val' },
                { slider: 'tempo', value: 'tempo-val' },
                { slider: 'expression', value: 'expression-val' },
                { slider: 'spatial', value: 'spatial-val' }
            ];

            sliders.forEach(({slider, value}) => {
                const sliderEl = document.getElementById(slider);
                const valueEl = document.getElementById(value);
                
                sliderEl.addEventListener('input', function() {
                    updateSliderValue(this, valueEl);
                });
                
                // Initialize values
                updateSliderValue(sliderEl, valueEl);
            });

            // Master volume
            document.getElementById('master-vol').addEventListener('input', function() {
                if (masterGain) {
                    masterGain.gain.setValueAtTime(this.value / 100, audioCtx.currentTime);
                }
            });

            // Start visualizer animation
            setInterval(updateVisualizer, 120);
        });

        // Touch optimization
        document.addEventListener('touchstart', function() {}, {passive: true});
        document.addEventListener('touchmove', function() {}, {passive: true});
    </script>
</body>
</html>